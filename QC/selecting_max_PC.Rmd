---
title: "Untitled"
author: "Brian"
date: "2025-09-26"
output: html_document
---

# Selecting the Maximum Number of PCs ("dims") for Downstream Analysis

The **typical starting point** for choosing the maximum number of principal components (PCs, or "dims") to use is to examine an elbow plot of your object. Assuming the object (e.g., `harmony_obj`) has been fully processed and is ready for `FindMultiModalNeighbors`, generate the elbow plot as follows:

```r
findElbow(harmony_obj)
```

## Excluding PC1 From the Elbow Plot

With our workflow and data, the standard elbow plot did not provide a satisfactory cutoff. We instead excluded PC1, which was determined to be technical, and generated the elbow plot for PC2 and higher:

```r
stdevs <- merged_data[["pca"]]@stdev
plot(2:length(stdevs), stdevs[2:length(stdevs)], type = "b",
     xlab = "PC", ylab = "Standard deviation of PCs",
     main = "Elbow Plot (excluding PC1)")
```

This approach indicated an elbow around **PC18** in our data, but the standard deviations remained reasonably significant even for higher components:

```
 [1] 12.97  6.58  5.53  5.28  4.54  4.35  3.48  3.15  2.96  2.66  2.61  2.46
[13]  2.38  2.20  2.16  2.14  2.08  1.97  1.92  1.89  1.84  1.79  1.72  1.71
[25]  1.68  1.67  1.64  1.62  1.60  1.58  1.54  1.53  1.51  1.45  1.44  1.43
[37]  1.42  1.41  1.40  1.38  1.34  1.34  1.32  1.31  1.29  1.28  1.27  1.26
[49]  1.25  1.24
```

Because of the statistical viability of PCs throughout the range, we performed a **parameter sweep** including up to the max PC value (50 in our case). Had there been a more distinct drop earlier in the data, that would have provided a clearer guide for selection.

## Parameter Sweep Example

Our parameter sweep is called as follows, with example settings in place at the time:

```r
param_grid <- expand.grid(
  dims_min = c(2),
  dims_max = c(31,36,40),
  knn = c(30,40,50)
)
resolutions <- c(0.06, 0.1)
parameter_sweep(
  merged_obj, param_grid, resolutions,
  output_dir = "/projects/opioid/parameter_sweep/report",
  plot_dir = "/projects/opioid/parameter_sweep/plots"
)
```

After running the sweep, we **reviewed the report and plots**. Combining insights from the elbow plot, the parameter sweep, and background biological knowledge, we selected a maximum PC for our dims (to be specified after review).

---
**Summary:**  
- Use the elbow plot (excluding PC1 if technical) as an initial guide.
- If the elbow is unclear and statistical support for higher PCs remains, run a parameter sweep across a range of max PC values.
- Select the max PC based on a combination of elbow plot, sweep results, and biological context.